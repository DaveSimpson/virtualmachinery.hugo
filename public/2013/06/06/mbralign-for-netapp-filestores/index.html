<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mbralign for NetApp filestores</title>
<meta name="description" content=" In which a VMware administrator, architect, designer, implementor, migrator, operator, vExpert (call me what you will) discusses, saves for his own posterity and shares with others, random information regarding the march towards a cloudy future...">
<meta name="generator" content="Hugo 0.26" />
<meta property="og:title" content="mbralign for NetApp filestores" />
<meta property="og:description" content="mbralign for VMware filestores" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2013/06/06/mbralign-for-netapp-filestores/" />



<meta property="article:published_time" content="2013-06-06T15:20:00&#43;00:00"/>
<meta property="article:modified_time" content="2013-06-06T15:20:00&#43;00:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<link rel="shortcut icon" href="/favicon.ico">

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
			<div class="container container-inner clearfix">
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
					<a class="logo__link" href="/" title="VirtualMachinery" rel="home">
						<h1 class="logo__title">VirtualMachinery</h1>
						<h2 class="logo__tagline">Discussing virtually anything</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/about/">ABOUT ME</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">mbralign for NetApp filestores</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2013-06-06T15:20:00">June 06, 2013</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/posts" rel="category">Posts</a></span>
			</p>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/img/20130606netapp.png" alt="mbralign for NetApp filestores">
			</figure>
			

<h2 id="intro">Intro</h2>

<p>Migrating VMs to a NetApp filer is all well and good, but there&rsquo;s a disk alignment issue to get past once those migrations are done, otherwise your expected performance will be seriously impacted.</p>

<p>You should use the version of the mbralign tool included with the latest NetApp Virtual Storage Console (VSC) to check VMDK partition alignment. There is a version of mbralign for ESX hosts and one for ESXi hosts and you&rsquo;re given the option to select the correct one at download. Grab the VSC from <a href="http://support.netapp.com/">http://support.netapp.com/</a></p>

<p>The mbralign tool is effective on both  -flat.vmdk and fixed .vhd files - as long as they are partitioned using an MBR partition table, rather than GPT.</p>

<h2 id="scanning">Scanning</h2>

<p>To scan for misaligned vmdk&rsquo;s from an ESX host console, change to the directory where mbralign is installed and enter the following command;</p>

<pre><code>./mbralign { --scan all | filename }
</code></pre>

<p>The &ndash;scan all option scans all -flat.vmdk files, whereas entering a -flat.vmdk scans one file.</p>

<p>The command displays whether the VMDK partition is correctly aligned, you will see information about the file(s) ending with Aligned: No or Aligned: Yes</p>

<h2 id="before-you-remediate">Before you Remediate</h2>

<p>Consider this relatively long list of caveats and warnings;</p>

<ul>
<li><p>For ESX clusters, you must run the mbralign program on the ESX host where the VM is currently registered. For NFS datastores, the mbralign program cannot detect if the VM is powered down if the VM is running on another ESX host.</p></li>

<li><p>Running the mbralign program on a VM that is powered on can corrupt the VMDK. You must then restore the VMDK from the backup created by mbralign.</p></li>

<li><p>When you use the feature to preserve Windows drive letter mapping, you start with the VM powered on, and mbralign powers it down after collecting drive letter mappings.</p></li>

<li><p>If you do not want to shut down the VM, take either a Data ONTAP Snapshot copy of the volume containing the Datastore LUN or NFS Datastore, or clone the VM in question, and then run mbrscan against the cloned copy.</p></li>

<li><p>Be aware that mbralign can take a number of minutes per gigabyte of storage to align files.</p></li>

<li><p>Consider VMware vCenter Converter as an option to align VMs if you cannot power machines off for long.</p></li>
</ul>

<h2 id="remediation-steps">Remediation Steps</h2>

<p>1 - Remove any VMware snapshots from the VM that is to be realigned. You can also think about removing any other drives that don&rsquo;t require alignment from the individual VM.
2 - For Linux VMs, and Windows VMs with only a C:\ drive, shut down the VM. For a Windows VM with multiple drive letters mapped, the VM must be running so that mbralign can collect the drive letter information before it shuts the VM down.
3 - On the ESX or ESXi host console, change to the directory containing the .vmdk file for the VM.
4 - Enter the following command:</p>

<pre><code>path/mbralign name.vmdk
</code></pre>

<p>path is the path where the mbralign program is installed.<br />
name is the name of the VMDK file being aligned.</p>

<p>5 - If prompted, enter yes for a Windows VM to automatically collect and restore drive letters. Enter the Windows Administrator credentials for the VM. The VM is automatically shut down after the drive letter information is collected.</p>

<p>6 - When prompted Are you sure that no snapshots/linked clones exist for this vmdk? Enter y.</p>

<p><strong>Attention:</strong> The use of mbralign on a VMDK file that has a snapshot or linked clone associated with it can result in unrecoverable data loss or data corruption.</p>

<p>7 - For Windows guest operating systems for which you are not using the drive letter restore feature, restart the VM and verify that the guest operating system boots successfully.</p>

<p>8 - For Linux guest operating systems using the GRUB boot loader, reinstall GRUB before restarting the VM.</p>

<p>9 - After verifying the VM has booted and is operating correctly, delete the backup files created by mbralign. These files are saved in the same directory as the .vmdk file and have names ending in -mbralign-backup.</p>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="m4.73135 3.3795002q0-.5597-.39604-.9557-.39604-.3961-.95577-.3961-.55974 0-.95578.3961-.39604.396-.39604.9557 0 .5598.39604.9558.39604.3961.95578.3961.55973 0 .95577-.3961.39604-.396.39604-.9558zm11.26865 6.0832q0 .5596998-.39076.9504998l-5.18548 5.196q-.41188.3908-.9610504.3908-.55974 0-.9505-.3908l-7.5511496-7.5616998q-.40132-.3907-.68119-1.0666-.27987-.6759-.27987-1.2357v-4.3934q0-.54920004.40132-.95050004.40132-.4013.9505-.4013h4.39339q.55974 0 1.23565.2799.67591.2798 1.07723.6812l7.55115 7.54060004q.39076.4118.39076.961z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/vmware/" rel="tag">VMware</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/netapp/" rel="tag">NetApp</a></li>
	</ul>
</div>

	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dave Simpson avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dave Simpson</span>
	</div>
	<div class="authorbox__description">
		vExpert, London/UK VMUG Leader, Homelabber and amateur hack blogger.
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/2013/05/24/vmware-vcloud-hybrid-service/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">VMware vCloud Hybrid Service</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/2013/07/05/lonvmug-vbeers-and-a-vcurry/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">LonVMUG, vBeers and a vCurry!</p></a>
	</div>
</nav>

	
<div class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "virtualmachinery" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2017/08/23/ship-blog-from-blogger-to-hugo/">Shipping a blog from Blogger to Hugo</a></li>
			<li class="widget__item"><a class="widget__link" href="/2016/11/11/away-at-midcon-vdm30in30/">Away at MidCon #vDM30in30</a></li>
			<li class="widget__item"><a class="widget__link" href="/2016/11/10/uk-vmug-usercon-community-focus-vdm30in30/">UK VMUG UserCon - Community Focus - #vDM30in30</a></li>
			<li class="widget__item"><a class="widget__link" href="/2016/11/09/fun-with-cloudcred-vdm30in30/">Fun with CloudCred! #vDM30in30</a></li>
			<li class="widget__item"><a class="widget__link" href="/2016/11/09/a-little-about-me-vdm30in30/">A little about me - #vDM30in30</a></li>
		</ul>
	</div>
</div>

	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/homelab">Homelab</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/posts">Posts</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/vdm30in30">Vdm30in30</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/vmworld">Vmworld</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/https://twitter.com/bfd_diplomacy" target="_blank">
				<svg class="widget-social__link-icon icon-twitter" viewBox="0 0 384 312" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="" rel="noopener noreferrer" href="https://linkedin.com/in/https://www.linkedin.com/in/vdavesimpson/" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff" xmlns="http://www.w3.org/2000/svg"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/https://github.com/DaveSimpson" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Facebook" rel="noopener noreferrer" href="https://facebook.com/https://www.facebook.com/dave.simpson.9659" target="_blank">
				<svg class="widget-social__link-icon icon-facebook" viewBox="0 0 352 352" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m0 32v288c0 17.5 14.5 32 32 32h288c17.5 0 32-14.5 32-32v-288c0-17.5-14.5-32-32-32h-288c-17.5 0-32 14.5-32 32zm320 0v288h-83v-108h41.5l6-48h-47.5v-31c0-14 3.5-23.5 23.5-23.5h26v-43.5c-4.4-.6-19.8-1.5-37.5-1.5-36.9 0-62 22.2-62 63.5v36h-42v48h42v108h-155v-288z"/></svg>
				<span>Facebook</span>
			</a>
		</div>
		
	</div>
</div>

	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget__link widget__link--taglist" href="/tags/aws" title="aws">aws (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blog" title="blog">blog (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/boardgames" title="boardgames">boardgames (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/certification" title="certification">certification (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/cisco" title="cisco">cisco (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/cloud" title="cloud">cloud (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/cloudcred" title="cloudcred">cloudcred (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/community" title="community">community (25)</a>
		<a class="widget__link widget__link--taglist" href="/tags/dell" title="dell">dell (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/diplomacy" title="diplomacy">diplomacy (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/dns" title="dns">dns (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/emc" title="emc">emc (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/evo" title="evo">evo (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/feed4ward" title="feed4ward">feed4ward (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/homelab" title="homelab">homelab (7)</a>
		<a class="widget__link widget__link--taglist" href="/tags/justforfun" title="justforfun">justforfun (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/lightwave" title="lightwave">lightwave (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/midcon" title="midcon">midcon (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/netapp" title="netapp">netapp (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/nuc" title="nuc">nuc (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/nutanix" title="nutanix">nutanix (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/openhomelab" title="openhomelab">openhomelab (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/photon" title="photon">photon (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/podcasts" title="podcasts">podcasts (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/pure-storage" title="pure-storage">pure-storage (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/ravello" title="ravello">ravello (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/srm" title="srm">srm (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/synology" title="synology">synology (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/tam-customer-central" title="tam-customer-central">tam-customer-central (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/usercon" title="usercon">usercon (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/v2d" title="v2d">v2d (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vbeers" title="vbeers">vbeers (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vcenter" title="vcenter">vcenter (7)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vchs" title="vchs">vchs (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vcurry" title="vcurry">vcurry (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vdm30in30" title="vdm30in30">vdm30in30 (10)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vexpert" title="vexpert">vexpert (22)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vmug" title="vmug">vmug (13)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vmware" title="vmware">vmware (41)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vmworld" title="vmworld">vmworld (25)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vrealize" title="vrealize">vrealize (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vrockstar" title="vrockstar">vrockstar (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vrops" title="vrops">vrops (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vsan" title="vsan">vsan (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/vsphere" title="vsphere">vsphere (9)</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright">&copy; 2017 VirtualMachinery. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad theme</a>.</span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
